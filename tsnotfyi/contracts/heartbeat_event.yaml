{
  "name": "HeartbeatEvent",
  "description": "Server-Sent Event payload produced by DriftAudioMixer.broadcastHeartbeat.",
  "normalization": [
    "Ensure `type` is always literal \"heartbeat\".",
    "Trim strings and coerce optional blocks to null when empty.",
    "Clamp timing metrics to non-negative values."
  ],
  "fields": {
    "type": {
      "type": "string",
      "required": true,
      "enum": ["heartbeat"]
    },
    "timestamp": {
      "type": "number",
      "required": true,
      "min": 0
    },
    "reason": {
      "type": "string",
      "required": true
    },
    "fingerprint": {
      "type": "string",
      "required": false,
      "allowNull": true
    },
    "currentTrack": {
      "type": "object",
      "required": true,
      "fields": {
        "identifier": {
          "type": "string",
          "required": true,
          "pattern": "^[a-f0-9]{32}$"
        },
        "title": {
          "type": "string",
          "required": false,
          "allowNull": true
        },
        "artist": {
          "type": "string",
          "required": false,
          "allowNull": true
        },
        "startTime": {
          "type": "number",
          "required": false,
          "allowNull": true
        },
        "durationMs": {
          "type": "number",
          "required": false,
          "allowNull": true,
          "min": 0
        }
      }
    },
    "timing": {
      "type": "object",
      "required": true,
      "fields": {
        "elapsedMs": {
          "type": "number",
          "required": false,
          "allowNull": true,
          "min": 0
        },
        "remainingMs": {
          "type": "number",
          "required": false,
          "allowNull": true,
          "min": 0
        }
      }
    },
    "nextTrack": {
      "type": "object",
      "required": false,
      "allowNull": true,
      "fields": {
        "track": {
          "type": "object",
          "required": false,
          "allowNull": true,
          "fields": {
            "identifier": {
              "type": "string",
              "required": true,
              "pattern": "^[a-f0-9]{32}$"
            },
            "title": {
              "type": "string",
              "required": false,
              "allowNull": true
            },
            "artist": {
              "type": "string",
              "required": false,
              "allowNull": true
            }
          }
        },
        "direction": {
          "type": "string",
          "required": false,
          "allowNull": true
        }
      }
    },
    "override": {
      "type": "object",
      "required": false,
      "allowNull": true,
      "fields": {
        "identifier": {
          "type": "string",
          "required": true,
          "pattern": "^[a-f0-9]{32}$"
        },
        "status": {
          "type": "string",
          "required": true,
          "enum": ["pending", "prepared", "locked"]
        },
        "direction": {
          "type": "string",
          "required": false,
          "allowNull": true
        }
      }
    },
    "session": {
      "type": "object",
      "required": true,
      "fields": {
        "id": {
          "type": "string",
          "required": true
        },
        "audioClients": {
          "type": "number",
          "required": true,
          "integer": true,
          "min": 0
        },
        "eventClients": {
          "type": "number",
          "required": true,
          "integer": true,
          "min": 0
        }
      }
    },
    "drift": {
      "type": "object",
      "required": true,
      "fields": {
        "currentDirection": {
          "type": "string",
          "required": false,
          "allowNull": true
        }
      }
    }
  },
  "invariants": [
    {
      "type": "comparison",
      "left": "timing.remainingMs",
      "op": ">=",
      "right": 0,
      "nullable": true,
      "literalRight": true
    },
    {
      "type": "comparison",
      "left": "timing.elapsedMs",
      "op": ">=",
      "right": 0,
      "nullable": true,
      "literalRight": true
    }
  ]
}
